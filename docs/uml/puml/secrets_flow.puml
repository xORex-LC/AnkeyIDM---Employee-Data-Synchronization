@startuml secrets_flow
left to right direction
skinparam packageStyle rectangle
skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam classBackgroundColor #FEFECE
skinparam classBorderColor #A80036
skinparam interfaceBackgroundColor #FEFECE
skinparam interfaceBorderColor #A80036

package "Domain" {
  class ValidationRowResult {
    match_key : str
    match_key_complete : bool
    secret_candidates : dict[str, str]
  }
  class PlanDecision {
    secret_fields : list[str]
  }
  class PlanItem {
    secret_fields : list[str]
    source_ref : dict[str, Any] | None
    desired_state : dict[str, Any]
  }
}

package "Ports" {
  interface SecretStoreProtocol
  interface SecretProviderProtocol
}

package "Use Cases" {
  class PlanUseCase
  class ImportApplyService
}

package "Datasets" {
  class EmployeesPlanningPolicy
  class EmployeesApplyAdapter
}

package "Infra" {
  class FileVaultSecretStore
  class FileVaultSecretProvider
}

ValidationRowResult --> PlanUseCase : secret_candidates
PlanUseCase ..> SecretStoreProtocol : put_many()
SecretStoreProtocol <|.. FileVaultSecretStore
SecretProviderProtocol <|.. FileVaultSecretProvider

EmployeesPlanningPolicy --> PlanDecision : secret_fields
PlanDecision --> PlanItem : secret_fields
PlanItem --> EmployeesApplyAdapter : secret_fields
ImportApplyService --> SecretProviderProtocol : get_secret()
EmployeesApplyAdapter --> SecretProviderProtocol : get_secret()

FileVaultSecretStore ..> FileVaultSecretProvider : vault CSV
PlanItem --> ValidationRowResult : match_key (via source_ref)
@enduml
